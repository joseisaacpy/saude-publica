<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Site oficial das academias p√∫blicas de Jos√© de Freitas, promovendo sa√∫de e bem-estar para todos com atividades f√≠sicas acess√≠veis."
    />
    <title>Sa√∫de P√∫blica - PI</title>
    <!-- Favicon -->
    <link
      rel="icon"
      type="image/png"
      href="./public/img/favicon/favicon-96x96.png"
      sizes="96x96"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="./public/img/favicon/favicon.svg"
    />
    <link rel="shortcut icon" href="./public/img/favicon/favicon.ico" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./public/img/favicon/apple-touch-icon.png"
    />
    <link rel="manifest" href="./public/img/favicon/site.webmanifest" />
    <!-- Font-Awesome -->
    <script
      src="https://kit.fontawesome.com/5432a0e64c.js"
      crossorigin="anonymous"
    ></script>
    <!-- Poopins -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <!-- Lottie Files -->
    <script
      src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"
      type="module"
    ></script>
    <!-- Umami Analytics -->
    <link rel="stylesheet" href="./src/style.css" />
  </head>
  <!-- Body com um padding top pra quando clicar nos links -->
  <body class="font-poppins scroll-pt-20 bg-slate-100">
    <!-- Header -->
    <header>
      <nav
        class="min-w-full flex items-center justify-between md:justify-around bg-azul_medio text-white p-4 shadow-md"
      >
        <a
          href="#"
          class="flex items-center hover:scale-110 transition-all duration-300"
        >
          <img
            src="./public/img/logo-saude-publica.png"
            class="w-16 h-16"
          /><span class="font-bold hidden md:block">Sa√∫de P√∫blica</span>
        </a>
        <ul class="hidden md:flex gap-4">
          <li>
            <a
              href="/"
              class="block font-bold text-white hover:scale-105 hover:text-amarelo transition-all"
              >Home</a
            >
          </li>
        </ul>
      </nav>
    </header>
    <!-- Main -->
    <main>
      <!-- Section do Form -->
      <section class="p-2">
        <h1 class="text-2xl md:text-3xl py-3 text-center font-bold">
          Formul√°rio de Cadastro
        </h1>
        <!-- Form -->
        <form
          id="cadForm"
          class="space-y-6 md:space-y-8 md:p-2 max-w-[700px] md:border-2 border-gray-300 rounded-lg mx-auto"
        >
          <!-- Nome (Required) -->
          <div>
            <label
              for="nome"
              class="block text-sm font-semibold text-gray-700 mb-2"
            >
              Nome Completo *
            </label>
            <input
              type="text"
              id="nome"
              name="nome"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 ease-in-out"
              placeholder="Digite seu nome completo"
            />
          </div>

          <!-- Tipo (Required) -->
          <div>
            <label
              for="tipo"
              class="block text-sm font-semibold text-gray-700 mb-2"
            >
              Voc√™ √©? *
            </label>
            <select
              id="tipo"
              name="tipo"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 ease-in-out"
            >
              <option disabled selected>Selecione:</option>
              <option value="aluno">Aluno</option>
              <option value="professor">Professor</option>
            </select>
          </div>

          <!-- CREF pra Professor (Required) (se for aluno, hidden) -->
          <div>
            <label
              for="cref"
              class="hidden text-sm font-semibold text-gray-700 mb-2"
            >
              CREF *
            </label>
            <input
              id="cref"
              name="cref"
              required
              class="hidden w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 ease-in-out"
              placeholder="Informe o CREF completo, como no documento (ex: 12345-G/PI)"
            />
          </div>
          <!-- Email  -->
          <div>
            <label for="email" class="text-sm font-semibold text-gray-700 mb-2">
              E-mail
            </label>
            <input
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 ease-in-out"
              placeholder="Digite seu E-mail"
            />
          </div>

          <!-- Data de Nascimento (Optional) -->
          <div>
            <label
              for="data_nascimento"
              class="block text-sm font-semibold text-gray-700 mb-2"
            >
              Data de Nascimento
            </label>
            <input
              type="date"
              id="data_nascimento"
              name="data_nascimento"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 ease-in-out"
            />
          </div>

          <!-- Sexo (Optional) -->
          <div>
            <label
              for="sexo"
              class="block text-sm font-semibold text-gray-700 mb-2"
            >
              Sexo
            </label>
            <select
              id="sexo"
              name="sexo"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 ease-in-out"
            >
              <option value="" disabled selected>Selecione o sexo</option>
              <option value="Masculino">Masculino</option>
              <option value="Feminino">Feminino</option>
              <option value="Outro">Outro</option>
            </select>
          </div>

          <!-- Telefone (Required) -->
          <div>
            <label
              for="telefone"
              class="block text-sm font-semibold text-gray-700 mb-2"
            >
              Telefone
            </label>
            <input
              type="tel"
              id="telefone"
              name="telefone"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 ease-in-out"
              placeholder="(11) 99999-9999"
            />
          </div>

          <!-- Endere√ßo (Optional) -->
          <div>
            <label
              for="endereco"
              class="block text-sm font-semibold text-gray-700 mb-2"
            >
              Endere√ßo
            </label>
            <input
              type="text"
              id="endereco"
              name="endereco"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 ease-in-out"
              placeholder="Rua, n√∫mero, complemento"
            />
          </div>

          <!-- Bairro e Cidade (Optional) -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="bairro"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                Bairro
              </label>
              <input
                type="text"
                id="bairro"
                name="bairro"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 ease-in-out"
                placeholder="Nome do bairro"
              />
            </div>
            <div>
              <label
                for="cidade"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                Cidade
              </label>
              <input
                type="text"
                id="cidade"
                name="cidade"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 ease-in-out"
                placeholder="Nome da cidade"
              />
            </div>
          </div>

          <!-- Academia (Optional) -->
          <!-- <div>
            <label
              for="academia_id"
              class="block text-sm font-semibold text-gray-700 mb-2"
            >
              Academia
            </label>
            <select
              id="academia_id"
              name="academia_id"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 ease-in-out"
            >
              <option value="">Selecione a academia</option>
            </select>
          </div> -->
          <!-- Op√ß√µes ser√£o carregadas dinamicamente -->

          <!-- Bot√µes de A√ß√£o -->
          <div class="flex flex-col sm:flex-row gap-4 pt-2">
            <button
              type="submit"
              class="flex-1 bg-amarelo hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 ease-in-out transform hover:scale-105"
            >
              Cadastrar Aluno
            </button>
            <button
              type="button"
              onclick="clearForm()"
              class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 ease-in-out transform hover:scale-105"
            >
              Limpar Formul√°rio
            </button>
          </div>
        </form>
      </section>
    </main>
    <script type="module" src="./src/main.js"></script>
    <script>
      // Fun√ß√£o para validar o email
      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // Fun√ß√£o para validar a data
      function isValidDate(str) {
        const data = new Date(str);
        return (
          str &&
          /^\d{4}-\d{2}-\d{2}$/.test(str) &&
          !isNaN(data.getTime()) &&
          data.getFullYear() > 1900 &&
          data.getFullYear() < 2100
        );
      }
      // Ao carregar o DOM, pega os elementos do formul√°rio que ser√£o ocultos
      document.addEventListener("DOMContentLoaded", () => {
        const tipoSelect = document.getElementById("tipo");
        const crefLabel = document.querySelector("label[for='cref']");
        const crefInput = document.getElementById("cref");

        // Adiciona evento de mudan√ßa no select
        tipoSelect.addEventListener("change", () => {
          // Se o valor selecionado for "professor", mostra o campo de CREF, se n√£o, oculta
          if (tipoSelect.value === "professor") {
            crefLabel.classList.remove("hidden");
            crefInput.classList.remove("hidden");
            crefInput.setAttribute("required", "required");
          } else {
            crefLabel.classList.add("hidden");
            crefInput.classList.add("hidden");
            crefInput.removeAttribute("required");
            crefInput.value = "";
          }
        });

        // Elemento do formul√°rio
        const formElement = document.getElementById("cadForm");
        // Adiciona evento de envio do form
        formElement.addEventListener("submit", async (e) => {
          // Evita o envio do formul√°rio
          e.preventDefault();

          // Valida√ß√£o inicial do tipo
          if (
            !tipoSelect.value ||
            (tipoSelect.value !== "professor" && tipoSelect.value !== "aluno")
          ) {
            alert("Por favor, selecione um tipo v√°lido!");
            return;
          }

          // Pega os dados do formul√°rio
          const dados = {
            nome: document.getElementById("nome").value,
            email: document.getElementById("email").value,
            telefone: document.getElementById("telefone").value,
            data_nascimento: document.getElementById("data_nascimento").value,
            sexo: document.getElementById("sexo").value,
            endereco: document.getElementById("endereco").value,
            bairro: document.getElementById("bairro").value,
            cidade: document.getElementById("cidade").value,
          };

          // Somente adiciona o CREF se for professor
          if (tipoSelect.value === "professor") {
            const cref = document.getElementById("cref").value;

            if (!cref || cref.trim() === "") {
              alert("O campo CREF √© obrigat√≥rio para professores.");
              return;
            }

            dados.cref = cref;
          }
          // Define a rota baseada no tipo selecionado
          const rota =
            tipoSelect.value === "professor" ? "professores" : "alunos";

          // Fun√ß√£o para fazer o cadastro da pessoa (seja professor ou aluno)
          const cadastroPessoa = async () => {
            // console.log("üì¶ Dados a enviar:", dados);

            // Desabilita o bot√£o de envio
            const submitButton = formElement.querySelector(
              'button[type="submit"]'
            );

            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = "Enviando...";

            // Faz requisi√ß√£o POST
            try {
              const data = document.getElementById("data_nascimento").value;

              if (!isValidDate(data)) {
                alert("Data de nascimento inv√°lida.");
                return;
              }

              // depois usa normalmente:
              dados.data_nascimento = data;

              const response = await fetch(
                `http://localhost:3000/api/${rota}`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(dados),
                }
              );

              // Verifica se a resposta foi bem-sucedida
              if (!response.ok) {
                // Tenta obter mais detalhes do erro
                const errorData = await response.json().catch(() => null);
                throw new Error(
                  errorData?.message ||
                    `Erro ${response.status}: ${response.statusText}`
                );
              }

              // Processa a resposta de sucesso
              const resultado = await response.json();
              alert(
                `${
                  tipoSelect.value === "professor" ? "Professor" : "Aluno"
                } cadastrado com sucesso!\nAguarde, pois teremos novidades...`
              );
              clearForm();

              // Log para debug (opcional)
              // console.log("Cadastro realizado:", resultado);
            } catch (error) {
              console.error("Erro ao cadastrar:", error);

              // Tratamento de erros mais espec√≠fico
              if (
                error.name === "TypeError" &&
                error.message.includes("fetch")
              ) {
                alert(
                  "Erro de conex√£o. Verifique se o servidor est√° funcionando."
                );
              } else if (error.message.includes("400")) {
                alert("Dados inv√°lidos. Verifique os campos preenchidos.");
              } else if (error.message.includes("409")) {
                alert("J√° existe um cadastro com esses dados.");
              } else if (error.message.includes("500")) {
                alert("Erro interno do servidor. Tente novamente mais tarde.");
              } else {
                alert(`Erro ao cadastrar: ${error.message}`);
              }
            } finally {
              // Sempre reabilita o bot√£o
              submitButton.disabled = false;
              submitButton.textContent = originalButtonText;
            }
          };

          // Chama a fun√ß√£o de cadastro
          await cadastroPessoa();
        });
      });

      // Fun√ß√£o para limpar o formul√°rio
      function clearForm() {
        const formElement = document.getElementById("cadForm");

        const crefLabel = document.querySelector("label[for='cref']");
        const crefInput = document.getElementById("cref");

        // Reset do formul√°rio
        formElement.reset();

        // Oculta o campo CREF se estiver vis√≠vel
        if (!crefLabel.classList.contains("hidden")) {
          crefLabel.classList.add("hidden");
          crefInput.classList.add("hidden");
          crefInput.removeAttribute("required");
        }
      }

      // Fun√ß√£o adicional para validar dados (opcional)
      function validarDados(dados, tipo) {
        const erros = [];

        if (!dados.nome || dados.nome.trim() === "") {
          erros.push("Nome √© obrigat√≥rio");
        }

        if (!dados.email || dados.email.trim() === "") {
          erros.push("Email √© obrigat√≥rio");
        } else if (!isValidEmail(dados.email)) {
          erros.push("Email inv√°lido");
        }
        // valida√ß√£o antes do insert
        if (!dados.sexo || dados.sexo.trim() === "") {
          return res.status(400).json({ error: "Campo 'sexo' √© obrigat√≥rio" });
        }

        if (tipo === "professor" && (!dados.cref || dados.cref.trim() === "")) {
          erros.push("CREF √© obrigat√≥rio para professores");
        }

        return erros;
      }
    </script>
  </body>
</html>
